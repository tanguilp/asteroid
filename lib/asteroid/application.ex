defmodule Asteroid.Application do
  @moduledoc false

  use Application

  import Asteroid.Utils

  alias Asteroid.AttributeRepository
  alias Asteroid.ObjectStore
  alias Asteroid.Crypto

  def start(_type, _args) do
    children = [
      {Phoenix.PubSub, [name: Asteroid.PubSub, adapter: Phoenix.PubSub.PG2]},
      AsteroidWeb.Endpoint
    ]

    with :ok <- AttributeRepository.auto_install_from_config(),
         :ok <- AttributeRepository.auto_start_from_config(),
         :ok <- ObjectStore.auto_install_from_config(),
         :ok <- ObjectStore.auto_start_from_config(),
         :ok <- Crypto.Key.load_from_config!() do
      if astrenv(:crypto_jws_none_alg_enabled, false) do
        JOSE.JWA.unsecured_signing(true)
      end

      opts = [strategy: :one_for_one, name: Asteroid.Supervisor]
      Supervisor.start_link(children, opts)
    end
  end

  def config_change(changed, _new, removed) do
    AsteroidWeb.Endpoint.config_change(changed, removed)
    :ok
  end
end
